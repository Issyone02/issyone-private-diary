<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Daily Diary Vault</title>
    <style>
      :root {
        --primary-color: #764ba2;
        --accent: #ff007a;
        --bg-gradient: linear-gradient(
          135deg,
          #667eea 0%,
          var(--primary-color) 100%
        );
        --card-bg: #ffffff;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --border: #eeeeee;
        --hover: #f0f0f0;
        --danger: #ff4757;
        --success: #2ecc71;
        --info: #0984e3;
      }

      body.dark-mode {
        --bg-gradient: linear-gradient(135deg, #1e1e2f 0%, #121212 100%);
        --card-bg: #1e1e1e;
        --text-main: #ffffff;
        --text-sub: #b2bec3;
        --border: #333333;
        --hover: #2d2d2d;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-gradient);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 20px;
        transition: all 0.3s ease;
      }

      #time-widget-container {
        position: absolute;
        top: 60px;
        right: 20px;
        z-index: 500;
        cursor: pointer;
        transition: transform 0.2s;
      }
      #time-widget-container:hover {
        transform: scale(1.05);
      }

      .digital-clock {
        background: rgba(0, 0, 0, 0.3);
        color: white;
        padding: 10px 15px;
        border-radius: 15px;
        backdrop-filter: blur(5px);
        text-align: right;
        font-family: "Courier New", Courier, monospace;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .digital-day {
        font-size: 0.7rem;
        text-transform: uppercase;
        opacity: 0.8;
        margin-bottom: 2px;
      }
      .digital-time {
        font-size: 1.2rem;
        font-weight: bold;
      }

      .analog-clock {
        width: 80px;
        height: 80px;
        border: 3px solid white;
        border-radius: 50%;
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
      }
      .hand {
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform-origin: bottom;
        background: white;
        border-radius: 5px;
      }
      .hour-hand {
        width: 4px;
        height: 25%;
        z-index: 3;
      }
      .min-hand {
        width: 3px;
        height: 35%;
        z-index: 2;
      }
      .sec-hand {
        width: 1px;
        height: 40%;
        background: var(--accent);
        z-index: 1;
      }
      .center-dot {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 4;
      }

      #lock-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-gradient);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
      }
      .pin-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      #pin-input {
        padding: 15px;
        font-size: 2rem;
        width: 160px;
        text-align: center;
        border-radius: 15px;
        border: none;
        margin-top: 20px;
        letter-spacing: 10px;
        outline: none;
        color: var(--primary-color);
      }
      #save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
        z-index: 1000;
      }
      #quote-ticker {
        width: 100%;
        background: rgba(0, 0, 0, 0.2);
        padding: 10px 0;
        margin-bottom: 20px;
        overflow: hidden;
        white-space: nowrap;
        color: white;
      }
      .scrolling-text {
        display: inline-block;
        padding-left: 100%;
        animation: ticker 25s linear infinite;
        font-style: italic;
      }
      @keyframes ticker {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(-100%, 0);
        }
      }
      .main-title {
        color: white;
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 10px;
      }

      #search-container {
        width: 100%;
        max-width: 400px;
        margin-bottom: 15px;
      }
      #search-bar {
        width: 100%;
        padding: 12px 20px;
        border-radius: 25px;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        outline: none;
        background: var(--card-bg);
        color: var(--text-main);
      }
      #controls {
        background: var(--card-bg);
        padding: 10px 20px;
        border-radius: 50px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 15px;
        color: var(--text-main);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .page-wrapper {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 30px;
        max-width: 1100px;
        width: 100%;
      }
      #side-panel {
        flex: 1;
        min-width: 300px;
        max-width: 350px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        color: var(--text-main);
        text-align: center;
      }

      .photo-gallery {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 10px 0;
        scroll-snap-type: x mandatory;
        margin-bottom: 10px;
        min-height: 50px;
      }
      .gallery-item {
        position: relative;
        flex: 0 0 120px;
        height: 120px;
        scroll-snap-align: start;
      }
      .gallery-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid var(--primary-color);
        cursor: pointer;
      }
      .del-img {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        margin-top: 10px;
      }
      .stat-box {
        font-size: 0.8rem;
        text-align: center;
        color: var(--text-sub);
      }
      #mood-summary {
        font-size: 0.85rem;
        margin-top: 12px;
        font-style: italic;
        color: var(--primary-color);
        border-top: 1px dashed var(--border);
        padding-top: 8px;
      }

      .reminder-setting {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed var(--border);
        text-align: left;
      }
      .reminder-setting label {
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--text-sub);
      }
      .reminder-input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px;
        margin-top: 5px;
        outline: none;
        background: var(--card-bg);
        color: var(--text-main);
        box-sizing: border-box;
      }

      #calendar-container {
        flex: 1.2;
        min-width: 320px;
        max-width: 450px;
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        color: var(--text-main);
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        text-align: center;
      }
      .day {
        aspect-ratio: 1 / 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 10px;
        cursor: pointer;
        position: relative;
        transition: 0.3s;
      }
      .day:hover {
        transform: scale(1.1);
        background: var(--hover);
      }
      .selected {
        background: rgba(118, 75, 162, 0.2);
        box-shadow: inset 0 0 0 2px var(--primary-color);
      }
      .today {
        background: var(--accent) !important;
        color: white;
      }

      .btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 20px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        transition: 0.2s;
        font-weight: bold;
      }
      .btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
      }
      .btn-small {
        width: auto;
        padding: 5px 15px;
        font-size: 0.8rem;
        margin: 0;
      }
      .btn-backup {
        background: var(--info);
      }
      .btn-restore {
        background: var(--success);
      }
      #clear-btn {
        margin: 40px 0;
        background: rgba(255, 71, 87, 0.1);
        color: #ff4757;
        border: 1px solid #ff4757;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
      }
      #clear-btn:hover {
        background: #ff4757;
        color: white;
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <div id="lock-screen">
      <div class="pin-box">
        <h2 id="lock-msg">Set Your Diary PIN</h2>
        <p style="font-size: 0.8rem; opacity: 0.8">Secure your memories</p>
        <input
          type="password"
          id="pin-input"
          maxlength="4"
          placeholder="****"
          oninput="validatePin()"
        />
      </div>
    </div>

    <div id="save-indicator">‚úì Saved</div>
    <div id="quote-ticker">
      <div class="scrolling-text" id="quote-text">Loading inspiration...</div>
    </div>

    <div id="time-widget-container" onclick="toggleClockMode()">
      <div id="digital-view" class="digital-clock">
        <div id="clock-day" class="digital-day">Monday</div>
        <div id="clock-time" class="digital-time">00:00:00</div>
      </div>
      <div id="analog-view" class="analog-clock" style="display: none">
        <div class="center-dot"></div>
        <div id="h-hand" class="hand hour-hand"></div>
        <div id="m-hand" class="hand min-hand"></div>
        <div id="s-hand" class="hand sec-hand"></div>
      </div>
    </div>

    <h1 class="main-title">My Daily Diary</h1>

    <div id="search-container">
      <input
        type="text"
        id="search-bar"
        placeholder="üîç Search entries..."
        oninput="searchEntries()"
      />
    </div>

    <div id="controls">
      <button id="dark-toggle" class="btn btn-small">üåì Mode</button>
      <button onclick="exportData()" class="btn btn-small btn-backup">
        üíæ Backup
      </button>
      <button
        onclick="document.getElementById('import-input').click()"
        class="btn btn-small btn-restore"
      >
        üìÇ Restore
      </button>
      <input
        type="file"
        id="import-input"
        style="display: none"
        accept=".json"
        onchange="importData(event)"
      />
      <input
        type="color"
        id="colorPicker"
        value="#764ba2"
        style="
          border: none;
          width: 30px;
          height: 30px;
          cursor: pointer;
          background: none;
        "
      />
    </div>

    <div class="page-wrapper">
      <div id="side-panel">
        <div class="card">
          <h3>Gallery</h3>
          <div id="photo-gallery" class="photo-gallery"></div>
          <p id="no-photo-text">No photos for this date.</p>
          <label for="photo-input" class="btn" style="display: block"
            >üì∑ Add Photo</label
          >
          <input
            type="file"
            id="photo-input"
            accept="image/*"
            style="display: none"
            multiple
            onchange="handleImages(event)"
          />
        </div>

        <div class="card">
          <p style="margin: 0; font-weight: bold; font-size: 0.9rem">
            Monthly Mood Tracker
          </p>
          <div class="stats-grid" id="statsGrid"></div>
          <div id="mood-summary">Record moods to see your summary!</div>

          <div class="reminder-setting">
            <label>üîî Entry Reminder Time</label>
            <div style="display: flex; gap: 5px; margin-top: 5px">
              <input
                type="time"
                id="reminder-time"
                class="reminder-input"
                onchange="saveReminderTime()"
              />
              <button
                onclick="requestNotificationPermission()"
                class="btn btn-small"
                style="margin: 0; font-size: 0.6rem"
              >
                üîî Enable
              </button>
            </div>
            <p
              id="notif-status"
              style="font-size: 0.6rem; color: var(--text-sub); margin-top: 5px"
            >
              Permission: Checking...
            </p>
          </div>
        </div>
      </div>

      <div id="calendar-container">
        <div
          class="header"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <button
            onclick="changeMonth(-1)"
            style="
              border: none;
              background: none;
              color: var(--text-main);
              cursor: pointer;
              font-size: 1.2rem;
            "
          >
            ‚ùÆ
          </button>
          <h2 id="monthDisplay" style="font-size: 1.2rem; margin: 0"></h2>
          <button
            onclick="changeMonth(1)"
            style="
              border: none;
              background: none;
              color: var(--text-main);
              cursor: pointer;
              font-size: 1.2rem;
            "
          >
            ‚ùØ
          </button>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>

        <div id="event-display" style="margin-top: 20px">
          <h3
            id="selected-date-text"
            style="font-size: 1rem; margin-bottom: 10px"
          >
            Select a date
          </h3>
          <div id="mood-section" style="display: none">
            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 1.5rem;
                margin-bottom: 5px;
              "
            >
              <span
                class="mood-emoji"
                onclick="setMood('üòä')"
                style="cursor: pointer"
                >üòä</span
              >
              <span
                class="mood-emoji"
                onclick="setMood('ü§©')"
                style="cursor: pointer"
                >ü§©</span
              >
              <span
                class="mood-emoji"
                onclick="setMood('üòê')"
                style="cursor: pointer"
                >üòê</span
              >
              <span
                class="mood-emoji"
                onclick="setMood('üò¢')"
                style="cursor: pointer"
                >üò¢</span
              >
              <span
                class="mood-emoji"
                onclick="setMood('üò¥')"
                style="cursor: pointer"
                >üò¥</span
              >
            </div>
            <button
              onclick="clearMood()"
              style="
                background: none;
                border: none;
                color: var(--danger);
                font-size: 0.7rem;
                cursor: pointer;
              "
            >
              Reset Mood
            </button>
          </div>
          <ul
            id="event-list"
            style="
              list-style: none;
              padding: 0;
              margin: 10px 0;
              font-size: 0.95rem;
            "
          ></ul>
          <button
            onclick="addNote()"
            id="add-btn"
            style="display: none"
            class="btn"
          >
            + Write Thoughts
          </button>
        </div>
      </div>
    </div>

    <button id="clear-btn" onclick="clearAllData()">‚ö†Ô∏è Clear All Data</button>

    <script>
      let dt = new Date();
    let data = JSON.parse(localStorage.getItem("diaryData")) || {};
    let selectedDateKey = null;
    let savedPin = localStorage.getItem("diaryPin");
    let isAnalog = false;

    // --- AUTO-LOCK LOGIC ---
    // --- AUTO-LOCK LOGIC WITH WARNING ---
    let idleTimer;
    let warningTimer;
    const idleLimit = 30000; // 30 seconds total
    const warningTime = 10000; // 10 seconds warning

    // Create the warning element dynamically
    const lockWarning = document.createElement('div');
    lockWarning.id = 'lock-warning';
    lockWarning.style = "position:fixed; bottom:20px; right:20px; background:var(--danger); color:white; padding:12px 20px; border-radius:15px; font-weight:bold; box-shadow:0 10px 20px rgba(0,0,0,0.3); display:none; z-index:10000; animation: pulse 1s infinite;";
    lockWarning.innerHTML = "‚ö†Ô∏è Locking in 10s... Move to stay!";
    document.body.appendChild(lockWarning);

    // Add CSS pulse animation for the warning
    const style = document.createElement('style');
    style.innerHTML = "@keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }";
    document.head.appendChild(style);

    function resetIdleTimer() {
        // Hide warning and clear both timers
        lockWarning.style.display = 'none';
        clearTimeout(idleTimer);
        clearTimeout(warningTimer);

        // Timer to show the warning 10s before lock
        warningTimer = setTimeout(() => {
            if (isUnlocked()) {
                lockWarning.style.display = 'block';
                startCountdown(10);
            }
        }, idleLimit - warningTime);

        // Timer for the actual lock
        idleTimer = setTimeout(() => {
            if (isUnlocked()) {
                location.reload(); 
            }
        }, idleLimit);
    }

    function isUnlocked() {
        const lock = document.getElementById('lock-screen');
        return !lock || lock.style.display === 'none';
    }

    function startCountdown(seconds) {
        let count = seconds;
        const interval = setInterval(() => {
            count--;
            lockWarning.innerHTML = `‚ö†Ô∏è Locking in ${count}s... Move to stay!`;
            if (count <= 0 || lockWarning.style.display === 'none') clearInterval(interval);
        }, 1000);
    }

    // Event listeners to detect activity
    window.onload = resetIdleTimer;
    window.onmousemove = resetIdleTimer;
    window.onmousedown = resetIdleTimer; 
    window.ontouchstart = resetIdleTimer;
    window.onkeypress = resetIdleTimer;
    window.onscroll = resetIdleTimer;

    // --- REMINDER LOGIC ---
    function saveReminderTime() {
        const timeValue = document.getElementById('reminder-time').value;
        localStorage.setItem("diaryReminderTime", timeValue);
        triggerSaveFlash();
    }

    function requestNotificationPermission() {
        if (!("Notification" in window)) {
            alert("Browser doesn't support notifications.");
            return;
        }
        Notification.requestPermission().then(permission => {
            updateNotifStatus(permission);
            if (permission === "granted") {
                try {
                    new Notification("Vault Security üõ°Ô∏è", { 
                        body: "Reminders are now active!",
                        icon: "https://cdn-icons-png.flaticon.com/512/1066/1066371.png"
                    });
                } catch(e) {
                    alert("Permission granted! If no pop-up appeared, check your Windows/Mac 'Do Not Disturb' settings.");
                }
            } else {
                alert("Permission " + permission + ". Click the Lock icon in the URL bar to reset.");
            }
        });
    }

    function updateNotifStatus(perm) {
        const statusText = document.getElementById('notif-status');
        if (perm === "granted") {
            statusText.innerText = "Permission: Active ‚úÖ";
            statusText.style.color = "var(--success)";
        } else if (perm === "denied") {
            statusText.innerText = "Permission: Blocked ‚ùå";
            statusText.style.color = "var(--danger)";
        } else {
            statusText.innerText = "Permission: Not Set ‚ö†Ô∏è";
        }
    }

    function checkReminder() {
        const savedTime = localStorage.getItem("diaryReminderTime");
        if (!savedTime || Notification.permission !== "granted") return;
        const now = new Date();
        const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        if (currentTime === savedTime) {
            const todayKey = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
            if (!data[todayKey] || (!data[todayKey].note && (!data[todayKey].photos || data[todayKey].photos.length === 0))) {
                new Notification("Diary Reminder üìñ", { body: "You haven't recorded anything today!" });
            }
        }
    }
    setInterval(checkReminder, 60000);

    // --- CLOCK LOGIC ---
    function updateClock() {
        const now = new Date();
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        document.getElementById('clock-day').innerText = days[now.getDay()];
        document.getElementById('clock-time').innerText = now.toLocaleTimeString();
        const s = now.getSeconds(), m = now.getMinutes(), h = now.getHours();
        if(isAnalog){
            document.getElementById('s-hand').style.transform = `rotate(${s * 6}deg)`;
            document.getElementById('m-hand').style.transform = `rotate(${m * 6}deg)`;
            document.getElementById('h-hand').style.transform = `rotate(${h * 30 + m / 2}deg)`;
        }
    }
    setInterval(updateClock, 1000);

    function toggleClockMode() {
        isAnalog = !isAnalog;
        document.getElementById('digital-view').style.display = isAnalog ? 'none' : 'block';
        document.getElementById('analog-view').style.display = isAnalog ? 'block' : 'none';
        updateClock();
    }

    // --- PIN LOGIC ---
    if(savedPin) document.getElementById('lock-msg').innerText = "Enter Vault PIN";
    function validatePin() {
        const input = document.getElementById('pin-input');
        if (input.value.length === 4) {
            if (!savedPin) {
                localStorage.setItem("diaryPin", input.value);
                unlockDiary();
            } else if (input.value === savedPin) {
                unlockDiary();
            } else {
                alert("Incorrect PIN");
                input.value = "";
            }
        }
    }
    function unlockDiary() { document.getElementById('lock-screen').style.display = 'none'; }

    // --- CALENDAR & DATA ---
    function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";
        const year = dt.getFullYear(), month = dt.getMonth();
        document.getElementById("monthDisplay").innerText = `${dt.toLocaleDateString("en-US", {month:'long'})} ${year}`;
        ['S','M','T','W','T','F','S'].forEach(d => grid.innerHTML += `<div style="font-weight:bold; font-size:0.7rem; color:var(--text-sub)">${d}</div>`);
        const firstDay = new Date(year, month, 1).getDay();
        const days = new Date(year, month+1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
        for(let i=1; i<=days; i++) {
            const key = `${year}-${month+1}-${i}`;
            const isToday = i === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();
            const hasMedia = data[key]?.note || (data[key]?.photos && data[key].photos.length > 0);
            grid.innerHTML += `<div class="day ${isToday?'today':''} ${key===selectedDateKey?'selected':''}" onclick="selectDate('${key}')">
                ${i}${data[key]?.mood ? `<span style="font-size:0.6rem; position:absolute; bottom:2px">${data[key].mood}</span>`:''}
                ${hasMedia ? `<div style="width:4px; height:4px; background:var(--primary-color); border-radius:50%; position:absolute; top:4px"></div>`:''}
            </div>`;
        }
        updateStats();
    }

    function selectDate(key) {
        selectedDateKey = key;
        document.getElementById("selected-date-text").innerText = `Entry for: ${key}`;
        document.getElementById("mood-section").style.display = "block";
        document.getElementById("add-btn").style.display = "block";
        renderGallery();
        document.getElementById("event-list").innerHTML = data[key]?.note ? `<li>üìù ${data[key].note}</li>` : "<li>No notes for today.</li>";
        renderCalendar();
    }

    function save() {
        localStorage.setItem("diaryData", JSON.stringify(data));
        triggerSaveFlash();
        renderCalendar();
        renderGallery();
        if(selectedDateKey) selectDate(selectedDateKey);
    }

    function handleImages(e) {
        if(!selectedDateKey) return alert("Select a date first!");
        const files = Array.from(e.target.files);
        if(!data[selectedDateKey]) data[selectedDateKey] = { photos: [] };
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                if(!data[selectedDateKey].photos) data[selectedDateKey].photos = [];
                data[selectedDateKey].photos.push(event.target.result);
                save();
            };
            reader.readAsDataURL(file);
        });
    }

    function renderGallery() {
        const gallery = document.getElementById("photo-gallery");
        gallery.innerHTML = "";
        const photos = data[selectedDateKey]?.photos || [];
        document.getElementById("no-photo-text").style.display = photos.length ? "none" : "block";
        photos.forEach((src, index) => {
            const container = document.createElement('div');
            container.className = 'gallery-item';
            container.innerHTML = `<img src="${src}" class="gallery-img" onclick="window.open().document.write('<img src=\\'${src}\\'>')"><button class="del-img" onclick="removeImage(${index})">√ó</button>`;
            gallery.appendChild(container);
        });
    }

    function removeImage(index) { data[selectedDateKey].photos.splice(index, 1); save(); }

    function updateStats() {
        const grid = document.getElementById('statsGrid');
        const summary = document.getElementById('mood-summary');
        const year = dt.getFullYear(), month = dt.getMonth() + 1;
        let counts = { 'üòä':0, 'ü§©':0, 'üòê':0, 'üò¢':0, 'üò¥':0 }, total = 0;
        for (let key in data) {
            const [y, m] = key.split('-').map(Number);
            if (y === year && m === month && data[key].mood) { counts[data[key].mood]++; total++; }
        }
        grid.innerHTML = Object.keys(counts).map(e => `<div class="stat-box"><div>${e}</div><strong>${counts[e]}</strong></div>`).join('');
        if (total === 0) summary.innerText = "No moods this month.";
        else {
            const maxVal = Math.max(...Object.values(counts));
            const topMood = Object.keys(counts).find(key => counts[key] === maxVal);
            summary.innerText = "Monthly vibe: " + topMood;
        }
    }

    function addNote() {
        const entry = prompt("Thoughts:", data[selectedDateKey]?.note || "");
        if(entry !== null) {
            if(!data[selectedDateKey]) data[selectedDateKey] = {};
            data[selectedDateKey].note = entry.trim();
            save();
        }
    }

    function setMood(emoji) { if(!data[selectedDateKey]) data[selectedDateKey] = {}; data[selectedDateKey].mood = emoji; save(); }
    function clearMood() { if (data[selectedDateKey]?.mood) { delete data[selectedDateKey].mood; save(); } }
    function changeMonth(dir) { dt.setMonth(dt.getMonth()+dir); renderCalendar(); }
    function triggerSaveFlash() { const ind = document.getElementById('save-indicator'); ind.style.opacity = '1'; setTimeout(() => ind.style.opacity = '0', 1500); }
    function exportData() { const blob = new Blob([JSON.stringify(data)], {type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `diary-backup.json`; a.click(); }
    function clearAllData() { if(confirm("DANGER: Delete everything?")) { localStorage.clear(); location.reload(); } }
    
    function searchEntries() {
        const term = document.getElementById('search-bar').value.toLowerCase();
        if (!term) return;
        for (let key in data) {
            if (data[key].note && data[key].note.toLowerCase().includes(term)) {
                const [y, m, d] = key.split('-').map(Number);
                dt = new Date(y, m - 1, 1);
                selectedDateKey = key;
                renderCalendar();
                selectDate(key);
                break;
            }
        }
    }

    // --- INITIALIZATION ---
    if(localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');
    document.getElementById('dark-toggle').onclick = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
    };
    if(localStorage.getItem('diaryReminderTime')) document.getElementById('reminder-time').value = localStorage.getItem('diaryReminderTime');
    if ("Notification" in window) updateNotifStatus(Notification.permission);
    document.getElementById('colorPicker').oninput = (e) => document.documentElement.style.setProperty('--primary-color', e.target.value);
    
    const quotes = ["Create your own sunshine.", "Potential is endless.", "Gifts in every day."];
    document.getElementById('quote-text').innerText = quotes[new Date().getDate() % quotes.length];

    renderCalendar();
    updateClock();
    </script>
  </body>
</html>




